package api

import (
	"net/http"
	"net/http/pprof"

	"github.com/livp123/netxfw/internal/config"
	"github.com/livp123/netxfw/internal/plugins/types"
	"github.com/livp123/netxfw/internal/utils/logger"
	"github.com/livp123/netxfw/pkg/sdk"
)

// Server represents the API and UI server.
// Server ä»£è¡¨ API å’Œ UI æœåŠ¡å™¨ã€‚
type Server struct {
	sdk        *sdk.SDK
	port       int
	configPath string
}

// NewServer creates a new API and UI server instance.
// NewServer åˆ›å»ºä¸€ä¸ªæ–°çš„ API å’Œ UI æœåŠ¡å™¨å®ä¾‹ã€‚
func NewServer(s *sdk.SDK, port int) *Server {
	return &Server{
		sdk:        s,
		port:       port,
		configPath: config.GetConfigPath(),
	}
}

// Handler returns the http.Handler for the API and UI.
// Handler è¿”å› API å’Œ UI çš„ http.Handlerã€‚
func (s *Server) Handler() http.Handler {
	log := logger.Get(nil)
	// Auto-generate token if not configured
	// å¦‚æœæœªé…ç½® Tokenï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆ
	types.ConfigMu.Lock()
	
	// Load config using the new config manager
	cfgManager := config.GetConfigManager()
	err := cfgManager.LoadConfig()
	if err != nil {
		log.Errorf("Failed to load config: %v", err)
		types.ConfigMu.Unlock()
		return nil
	}
	
	cfg := cfgManager.GetConfig()
	if cfg == nil {
		log.Error("Config is nil after loading")
		types.ConfigMu.Unlock()
		return nil
	}
	
	if cfg.Web.Token == "" {
		token := generateRandomToken(16)
		cfg.Web.Token = token
		cfg.Web.Enabled = true
		cfg.Web.Port = s.port
		
		// Update config in the manager
		cfgManager.UpdateConfig(cfg)
		
		// Save config using the new config manager
		if err := cfgManager.SaveConfig(); err != nil {
			log.Errorf("Failed to save config: %v", err)
			types.ConfigMu.Unlock()
			return nil
		}
		
		log.Infof("ğŸ”‘ No Web Token configured. Automatically generated a new one: %s", token)
		log.Infof("ğŸ“ Token has been saved to %s", s.configPath)
	} else {
		log.Infof("ğŸ”‘ Using configured Web Token for authentication")
	}
</toolcall_result>
