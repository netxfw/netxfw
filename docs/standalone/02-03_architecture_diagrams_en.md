# NetXFW Standalone Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           NetXFW Standalone                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         User Interface Layer                         │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │   │
│  │  │   CLI Command │  │    Web UI     │  │      REST API         │   │   │
│  │  │  (netxfw)     │  │  (Port 11811) │  │    (Port 11818)       │   │   │
│  │  └───────┬───────┘  └───────┬───────┘  └───────────┬───────────┘   │   │
│  └──────────┼──────────────────┼──────────────────────┼───────────────┘   │
│             │                  │                      │                    │
│             └──────────────────┼──────────────────────┘                    │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Control Plane (Go)                               │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │   SDK Layer │ │   Config    │ │  Perf       │ │  Health     │   │   │
│  │  │ (pkg/sdk)   │ │  Management │ │  Monitoring │ │  Check      │   │   │
│  │  │             │ │ (config_    │ │ (perf_      │ │ (health_    │   │   │
│  │  │             │ │  cache)     │ │  stats)     │ │  check)     │   │   │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘   │   │
│  │         │               │               │               │          │   │
│  │  ┌──────┴───────────────┴───────────────┴───────────────┴──────┐   │   │
│  │  │                    XDP Adapter (internal/xdp)                │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │   │
│  │  │  │ Manager │ │  Maps   │ │ Loader  │ │ Migrator│           │   │   │
│  │  │  │ Interface│ │ Wrapper │ │         │ │         │           │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                    ┌───────────┴───────────┐                              │
│                    │   cilium/ebpf Library │                              │
│                    │   (BPF Syscalls)      │                              │
│                    └───────────┬───────────┘                              │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Data Plane (eBPF/XDP)                             │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    XDP Program (Kernel Space)                  │ │   │
│  │  │                                                               │ │   │
│  │  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │ │   │
│  │  │  │ Packet  │───▶│ Protocol│───▶│  Rule   │───▶│ Action  │   │ │   │
│  │  │  │  Entry  │    │  Parse  │    │  Match  │    │ Execute │   │ │   │
│  │  │  └─────────┘    └─────────┘    └─────────┘    └─────────┘   │ │   │
│  │  │                                                               │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │                    BPF Maps                             │ │ │   │
│  │  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐│ │ │   │
│  │  │  │  │Whitelist│ │Blacklist│ │Conntrack│ │RateLimit│ │ Stats  ││ │ │   │
│  │  │  │  │LPM Trie│ │LPM Trie│ │LRU Hash│ │Hash Map│ │Per-CPU ││ │ │   │
│  │  │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘│ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    TC Program (Egress Traffic)                 │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │ │   │
│  │  │  │  Egress Capture ───▶ Conn State Write ───▶ ct_map Update│  │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Persistence Layer                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                   │   │
│  │  │ config.yaml │ │ rules.json  │ │ BPF Pinning │                   │   │
│  │  │ (Config)    │ │ (Rules)     │ │ (/sys/fs/   │                   │   │
│  │  │             │ │             │ │  bpf/netxfw)│                   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Packet Processing Flow

```
                          Packet Arrives at NIC
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      XDP Hook (Driver Layer)   │
                    │   xdp_firewall Program Entry   │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      1. Plugin Execution       │
                    │      (Tail Call)               │
                    │      Check jmp_table[2-15]     │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      2. Protocol Dispatch      │
                    │      Parse Ethernet Header     │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      3. IP Version Check       │
                    │      IPv4 / IPv6               │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      4. Whitelist Check        │
                    │      LPM Trie Lookup           │
                    └───────────────┬───────────────┘
                                    │
                              ┌─────┴─────┐
                              │ Whitelist? │
                              └─────┬─────┘
                           Yes ┌────┴────┐ No
                               ▼         ▼
                         ┌─────────┐ ┌─────────────────┐
                         │  PASS   │ │ 5. Blacklist    │
                         │ XDP_PASS│ │    Check        │
                         └─────────┘ └────────┬────────┘
                                             │
                                       ┌─────┴─────┐
                                       │Blacklist? │
                                       └─────┬─────┘
                                    Yes ┌────┴────┐ No
                                        ▼         ▼
                                  ┌─────────┐ ┌─────────────────┐
                                  │  DROP   │ │ 6. Rule Match   │
                                  │XDP_DROP │ │    (IP+Port)    │
                                  └─────────┘ └────────┬────────┘
                                                     │
                                               ┌─────┴─────┐
                                               │  Match?   │
                                               └─────┬─────┘
                                            Yes ┌────┴────┐ No
                                                ▼         ▼
                                          ┌─────────┐ ┌─────────────────┐
                                          │ Action  │ │ 7. Rate Limit   │
                                          │Allow/Deny│ │    Check       │
                                          └─────────┘ └────────┬────────┘
                                                             │
                                                       ┌─────┴─────┐
                                                       │  Exceed?  │
                                                       └─────┬─────┘
                                                    Yes ┌────┴────┐ No
                                                        ▼         ▼
                                                  ┌─────────┐ ┌─────────────────┐
                                                  │  DROP   │ │ 8. Default      │
                                                  │XDP_DROP │ │    Policy       │
                                                  └─────────┘ └────────┬────────┘
                                                                     │
                                                               ┌─────┴─────┐
                                                               │DefaultDeny│
                                                               └─────┬─────┘
                                                            Yes ┌────┴────┐ No
                                                                ▼         ▼
                                                          ┌─────────┐ ┌─────────┐
                                                          │  DROP   │ │  PASS   │
                                                          │XDP_DROP │ │XDP_PASS │
                                                          └─────────┘ └─────────┘
```

## BPF Map Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BPF Maps Overview                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     LPM Trie Maps (Prefix Matching)                  │   │
│  │                                                                     │   │
│  │  ┌─────────────────────┐     ┌─────────────────────┐               │   │
│  │  │   static_blacklist  │     │     whitelist       │               │   │
│  │  │   ─────────────────  │     │   ─────────────────  │               │   │
│  │  │   Key: lpm_key      │     │   Key: lpm_key      │               │   │
│  │  │   - prefixlen       │     │   - prefixlen       │               │   │
│  │  │   - IPv6 address    │     │   - IPv6 address    │               │   │
│  │  │   Value: rule_value │     │   Value: rule_value │               │   │
│  │  │   - counter         │     │   - counter         │               │   │
│  │  │   - expires_at      │     │   - expires_at      │               │   │
│  │  │   - action          │     │   - action          │               │   │
│  │  │   Max: 2,000,000    │     │   Max: 100,000      │               │   │
│  │  └─────────────────────┘     └─────────────────────┘               │   │
│  │                                                                     │   │
│  │  ┌─────────────────────┐                                           │   │
│  │  │     rule_map        │                                           │   │
│  │  │   ─────────────────  │                                           │   │
│  │  │   Key: lpm_ip_port  │                                           │   │
│  │  │   - prefixlen       │                                           │   │
│  │  │   - port            │                                           │   │
│  │  │   - IPv6 address    │                                           │   │
│  │  │   Value: rule_value │                                           │   │
│  │  │   Max: 100,000      │                                           │   │
│  │  └─────────────────────┘                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     LRU Hash Maps (Auto Eviction)                    │   │
│  │                                                                     │   │
│  │  ┌─────────────────────┐     ┌─────────────────────┐               │   │
│  │  │ dynamic_blacklist   │     │   conntrack_map     │               │   │
│  │  │   ─────────────────  │     │   ─────────────────  │               │   │
│  │  │   Key: in6_addr     │     │   Key: ct_key       │               │   │
│  │  │   Value: rule_value │     │   - src_ip, dst_ip  │               │   │
│  │  │   Max: 1,000,000    │     │   - src_port,dst_port│               │   │
│  │  │   Auto-evict: LRU   │     │   - protocol        │               │   │
│  │  └─────────────────────┘     │   Value: ct_value   │               │   │
│  │                              │   - last_seen       │               │   │
│  │  ┌─────────────────────┐     │   Max: 100,000      │               │   │
│  │  │   ratelimit_map     │     │   Auto-evict: LRU   │               │   │
│  │  │   ─────────────────  │     └─────────────────────┘               │   │
│  │  │   Key: in6_addr     │                                           │   │
│  │  │   Value: rate_cfg   │                                           │   │
│  │  │   - rate, burst     │                                           │   │
│  │  │   - tokens          │                                           │   │
│  │  │   Max: 100,000      │                                           │   │
│  │  └─────────────────────┘                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Per-CPU Array (Statistics)                       │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                   stats_global_map                           │   │   │
│  │  │   ─────────────────────────────────────────────────────────  │   │   │
│  │  │   Key: __u32 (index)                                        │   │   │
│  │  │   Value: stats_global                                       │   │   │
│  │  │   - total_packets, total_pass, total_drop                   │   │   │
│  │  │   - drop_blacklist, drop_rate_limit, drop_port_blocked      │   │   │
│  │  │   - pass_whitelist, pass_rule, pass_established             │   │   │
│  │  │   Max: 64 slots                                             │   │   │
│  │  │   Per-CPU: No lock contention                               │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Control Plane Components

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Control Plane Architecture                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          SDK Layer (pkg/sdk)                         │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │  Blacklist  │ │  Whitelist  │ │    Rule     │ │  Conntrack  │   │   │
│  │  │    API      │ │    API      │ │    API      │ │    API      │   │   │
│  │  │  - Add()    │ │  - Add()    │ │  - Add()    │ │  - List()   │   │   │
│  │  │  - Remove() │ │  - Remove() │ │  - Remove() │ │  - Count()  │   │   │
│  │  │  - List()   │ │  - List()   │ │  - List()   │ │  - Flush()  │   │   │
│  │  │  - Clear()  │ │  - Clear()  │ │  - Import() │ │             │   │   │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘   │   │
│  │         │               │               │               │          │   │
│  │  ┌──────┴───────────────┴───────────────┴───────────────┴──────┐   │   │
│  │  │                      SDK Interface                           │   │   │
│  │  │  - Unified API for all operations                            │   │   │
│  │  │  - Thread-safe access                                        │   │   │
│  │  │  - Error handling                                            │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      XDP Adapter (internal/xdp)                      │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │   Manager   │ │    Maps     │ │   Loader    │ │  Migrator   │   │   │
│  │  │             │ │   Wrapper   │ │             │ │             │   │   │
│  │  │ - Init()    │ │ - GetMap()  │ │ - Load()    │ │ - Migrate() │   │   │
│  │  │ - Start()   │ │ - Update()  │ │ - Unload()  │ │ - Backup()  │   │   │
│  │  │ - Stop()    │ │ - Iterate() │ │ - Reload()  │ │ - Restore() │   │   │
│  │  │ - Status()  │ │ - Count()   │ │             │ │             │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Summary

| Stage | Component | Action | Result |
|-------|-----------|--------|--------|
| 1 | XDP Hook | Packet arrives | Driver-level capture |
| 2 | Plugin | Tail call execution | Custom processing |
| 3 | Parser | Protocol decode | IPv4/IPv6 identified |
| 4 | Whitelist | LPM lookup | Trusted IP bypass |
| 5 | Blacklist | LPM lookup | Blocked IP drop |
| 6 | Rule Map | IP+Port match | Specific rule action |
| 7 | Rate Limit | Token bucket | DDoS protection |
| 8 | Default | Policy check | Allow/Deny fallback |
