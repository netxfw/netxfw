# netxfw 单机版架构图 (Standalone Architecture Diagrams)

## 系统整体架构 (System Architecture Overview)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              netxfw 单机版                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         用户交互层 (User Interface)                  │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │   │
│  │  │   CLI 命令    │  │   Web UI      │  │    REST API           │   │   │
│  │  │  (netxfw)     │  │  (端口 11811)  │  │    (端口 11818)       │   │   │
│  │  └───────┬───────┘  └───────┬───────┘  └───────────┬───────────┘   │   │
│  └──────────┼──────────────────┼──────────────────────┼───────────────┘   │
│             │                  │                      │                    │
│             └──────────────────┼──────────────────────┘                    │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        控制面 (Control Plane - Go)                   │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │  SDK 层     │ │  配置管理    │ │  性能监控    │ │  健康检查    │   │   │
│  │  │ (pkg/sdk)   │ │ (config_    │ │ (perf_      │ │ (health_    │   │   │
│  │  │             │ │  cache)     │ │  stats)     │ │  check)     │   │   │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘   │   │
│  │         │               │               │               │          │   │
│  │  ┌──────┴───────────────┴───────────────┴───────────────┴──────┐   │   │
│  │  │                    XDP 适配器 (internal/xdp)                 │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │   │
│  │  │  │ Manager │ │  Maps   │ │ Loader  │ │ Migrator│           │   │   │
│  │  │  │ Interface│ │ Wrapper │ │         │ │         │           │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                    ┌───────────┴───────────┐                              │
│                    │   cilium/ebpf 库      │                              │
│                    │   (BPF 系统调用)       │                              │
│                    └───────────┬───────────┘                              │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      数据面 (Data Plane - eBPF/XDP)                  │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    XDP 程序 (内核态)                           │ │   │
│  │  │                                                               │ │   │
│  │  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │ │   │
│  │  │  │ 数据包  │───▶│ 协议    │───▶│ 规则    │───▶│ 动作    │   │ │   │
│  │  │  │ 入口    │    │ 解析    │    │ 匹配    │    │ 执行    │   │ │   │
│  │  │  └─────────┘    └─────────┘    └─────────┘    └─────────┘   │ │   │
│  │  │                                                               │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │                    BPF Maps                             │ │ │   │
│  │  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐│ │ │   │
│  │  │  │  │白名单  │ │黑名单  │ │连接跟踪│ │限速规则│ │统计计数││ │ │   │
│  │  │  │  │LPM Trie│ │LPM Trie│ │LRU Hash│ │Hash Map│ │Per-CPU ││ │ │   │
│  │  │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘│ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    TC 程序 (Egress - 出站流量)                 │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │ │   │
│  │  │  │  出站包捕获 ───▶ 连接状态写入 ───▶ ct_map 更新           │  │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        持久化层 (Persistence Layer)                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                   │   │
│  │  │ config.yaml │ │ rules.json  │ │ BPF Pinning │                   │   │
│  │  │ (配置文件)  │ │ (规则持久化) │ │ (/sys/fs/   │                   │   │
│  │  │             │ │             │ │  bpf/netxfw)│                   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据包处理流程 (Packet Processing Flow)

```
                              数据包到达网卡
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      XDP 钩子 (驱动层)         │
                    │   xdp_firewall 程序入口       │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      1. 插件执行 (Tail Call)   │
                    │      检查 jmp_table[2-15]     │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      2. 协议分发              │
                    │   ┌─────────┐ ┌─────────┐    │
                    │   │ IPv4   │ │ IPv6    │    │
                    │   └────┬────┘ └────┬────┘    │
                    └────────┼───────────┼─────────┘
                             │           │
                    ┌────────┴───────────┴────────┐
                    │      3. 基础安全检查         │
                    │   ┌─────────────────────┐   │
                    │   │ • Bogon 过滤        │   │
                    │   │ • 分片包处理        │   │
                    │   │ • TCP 状态校验      │   │
                    │   │ • 源地址防欺骗      │   │
                    │   └─────────────────────┘   │
                    └───────────────┬─────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │      4. 规则匹配              │
                    │   ┌─────────────────────┐    │
                    │   │ 白名单 (最高优先级)  │──────▶ XDP_PASS
                    │   └──────────┬──────────┘    │
                    │              ▼               │
                    │   ┌─────────────────────┐    │
                    │   │ 动态黑名单 (LRU)    │──────▶ XDP_DROP
                    │   └──────────┬──────────┘    │
                    │              ▼               │
                    │   ┌─────────────────────┐    │
                    │   │ 静态黑名单 (LPM)    │──────▶ XDP_DROP
                    │   └──────────┬──────────┘    │
                    │              ▼               │
                    │   ┌─────────────────────┐    │
                    │   │ IP 限速 (令牌桶)    │──────▶ XDP_DROP (超限)
                    │   └──────────┬──────────┘    │
                    │              ▼               │
                    │   ┌─────────────────────┐    │
                    │   │ 连接追踪 (ct_map)   │──────▶ XDP_PASS (已知连接)
                    │   └──────────┬──────────┘    │
                    │              ▼               │
                    │   ┌─────────────────────┐    │
                    │   │ IP+Port 规则        │──────▶ XDP_DROP/PASS
                    │   └──────────┬──────────┘    │
                    └──────────────┼───────────────┘
                                   │
                    ┌──────────────┴───────────────┐
                    │      5. 默认策略              │
                    │   ┌─────────────────────┐    │
                    │   │ default_deny=true?  │    │
                    │   │   是: 端口白名单    │    │
                    │   │   否: XDP_PASS      │    │
                    │   └─────────────────────┘    │
                    └───────────────┬──────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │         XDP_PASS              │
                    │      (数据包进入内核栈)        │
                    └───────────────────────────────┘
```

## 配置热重载流程 (Hot Reload Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          配置热重载流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户修改配置文件                                                            │
│  /etc/netxfw/config.yaml                                                    │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────┐                                                        │
│  │ netxfw reload   │                                                        │
│  │ xdp             │                                                        │
│  └────────┬────────┘                                                        │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    控制面处理流程                                    │   │
│  │                                                                     │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │   │
│  │  │ 1. 加载新   │───▶│ 2. 创建新   │───▶│ 3. 检测配置 │            │   │
│  │  │    配置     │    │    BPF 对象 │    │    变更类型 │            │   │
│  │  └─────────────┘    └─────────────┘    └──────┬──────┘            │   │
│  │                                                │                   │   │
│  │                    ┌───────────────────────────┼───────────────┐   │   │
│  │                    │                           │               │   │   │
│  │                    ▼                           ▼               │   │   │
│  │  ┌─────────────────────────┐   ┌─────────────────────────┐    │   │   │
│  │  │ 增量重载                │   │ 完整重载                │    │   │   │
│  │  │ (容量未变化)            │   │ (容量变化)              │    │   │   │
│  │  │                         │   │                         │    │   │   │
│  │  │ • 更新 BPF 全局变量     │   │ • 创建新 Map            │    │   │   │
│  │  │ • 无需迁移数据          │   │ • 迁移旧 Map 数据       │    │   │   │
│  │  │ • 原子替换程序          │   │ • 原子替换程序          │    │   │   │
│  │  │                         │   │ • 关闭旧 BPF 对象       │    │   │   │
│  │  └─────────────────────────┘   └─────────────────────────┘    │   │   │
│  │                                                                │   │   │
│  └────────────────────────────────────────────────────────────────┘   │   │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    状态迁移 (Migrator)                               │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  旧 Map                      新 Map                         │   │   │
│  │  │  ┌─────────┐                ┌─────────┐                    │   │   │
│  │  │  │whitelist│ ──迭代复制──▶ │whitelist│                    │   │   │
│  │  │  ├─────────┤                ├─────────┤                    │   │   │
│  │  │  │lock_list│ ──迭代复制──▶ │lock_list│                    │   │   │
│  │  │  ├─────────┤                ├─────────┤                    │   │   │
│  │  │  │ct_map   │ ──迭代复制──▶ │ct_map   │                    │   │   │
│  │  │  ├─────────┤                ├─────────┤                    │   │   │
│  │  │  │rate_limit│ ──迭代复制──▶│rate_limit│                   │   │   │
│  │  │  └─────────┘                └─────────┘                    │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│           │                                                                 │
│           ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    原子替换 (Atomic Swap)                            │   │
│  │                                                                     │   │
│  │  ┌─────────────┐                    ┌─────────────┐                │   │
│  │  │ 旧 XDP 程序 │ ────原子替换────▶ │ 新 XDP 程序 │                │   │
│  │  │ (运行中)    │                    │ (运行中)    │                │   │
│  │  └─────────────┘                    └─────────────┘                │   │
│  │                                                                     │   │
│  │  特点: 无中断、无丢包、连接状态保持                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 组件交互图 (Component Interaction)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          组件交互关系                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         CLI 层 (Cobra)                               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │
│  │  │  root    │ │  rule    │ │  limit   │ │  system  │ │  perf    │  │   │
│  │  │  cmd     │ │  cmd     │ │  cmd     │ │  cmd     │ │  cmd     │  │   │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘  │   │
│  └───────┼────────────┼────────────┼────────────┼────────────┼────────┘   │
│          │            │            │            │            │            │
│          └────────────┴────────────┴─────┬──────┴────────────┘            │
│                                          │                                │
│                                          ▼                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         SDK 层 (pkg/sdk)                             │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    SDK Interface                               │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │  │   │
│  │  │  │RuleAPI  │ │LimitAPI │ │StatsAPI │ │ConfigAPI│ │ConnAPI  │ │  │   │
│  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ │  │   │
│  │  └───────┼───────────┼───────────┼───────────┼───────────┼───────┘  │   │
│  └──────────┼───────────┼───────────┼───────────┼───────────┼──────────┘   │
│             │           │           │           │           │              │
│             └───────────┴───────────┴─────┬─────┴───────────┘              │
│                                           │                                │
│                                           ▼                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      XDP 适配器层 (internal/xdp)                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Manager Interface                           │  │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │  │   │
│  │  │  │ MapWrapper  │ │ PerfStats   │ │ HealthCheck │             │  │   │
│  │  │  │             │ │             │ │             │             │  │   │
│  │  │  │ • whitelist │ │ • Latency   │ │ • Map Status│             │  │   │
│  │  │  │ • lock_list │ │ • Throughput│ │ • Error Rate│             │  │   │
│  │  │  │ • ct_map    │ │ • Cache Hit │ │ • Memory    │             │  │   │
│  │  │  │ • rate_limit│ │             │ │             │             │  │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘             │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                           │                                │
│                                           ▼                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        核心层 (internal/core)                        │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │ ConfigCache │ │ Engine      │ │ Validator   │ │ StatsCache  │   │   │
│  │  │             │ │             │ │             │ │             │   │   │
│  │  │ • Load      │ │ • Start     │ │ • Config    │ │ • Global    │   │   │
│  │  │ • Save      │ │ • Stop      │ │ • Rules     │ │ • Drop      │   │   │
│  │  │ • HotReload │ │ • Reload    │ │ • Ports     │ │ • Pass      │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                           │                                │
│                                           ▼                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        API 层 (internal/api)                         │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    HTTP Server (Chi Router)                  │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │   │
│  │  │  │/health  │ │/api/    │ │/api/    │ │/metrics │           │   │   │
│  │  │  │         │ │stats    │ │config   │ │         │           │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │   │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │   │
│  │  │  │/api/    │ │/api/    │ │/api/    │ │/version │           │   │   │
│  │  │  │rules    │ │conntrack│ │perf     │ │         │           │   │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## BPF Map 结构 (BPF Map Structure)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          BPF Map 结构概览                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  /sys/fs/bpf/netxfw/                                                        │
│  │                                                                          │
│  ├── whitelist (LPM Trie)                                                   │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: 128-bit IPv6 地址 (IPv4 映射为 ::ffff:x.x.x.x)            │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   action: u8,      // 动作类型                                  │    │
│  │   │   reason: [64]u8  // 原因描述                                   │    │
│  │   │ }                                                               │    │
│  │   │ 用途: 白名单 IP/网段，最高优先级放行                            │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── lock_list (LPM Trie)                                                   │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: 128-bit IPv6 地址                                          │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   action: u8,                                                   │    │
│  │   │   reason: [64]u8,                                               │    │
│  │   │   created_at: u64,                                              │    │
│  │   │   expires_at: u64                                               │    │
│  │   │ }                                                               │    │
│  │   │ 用途: 静态黑名单，支持 CIDR 网段                                │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── dyn_lock_list (LRU Hash)                                               │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: 32-bit IPv4 或 128-bit IPv6 地址                          │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   blocked_at: u64,                                              │    │
│  │   │   reason: [32]u8                                                │    │
│  │   │ }                                                               │    │
│  │   │ 用途: 动态黑名单，自动过期淘汰                                  │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── ct_map (LRU Hash)                                                      │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: struct {                                                   │    │
│  │   │   src_ip: [16]u8,                                               │    │
│  │   │   dst_ip: [16]u8,                                               │    │
│  │   │   src_port: u16,                                                │    │
│  │   │   dst_port: u16,                                                │    │
│  │   │   proto: u8                                                     │    │
│  │   │ }                                                               │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   state: u8,                                                    │    │
│  │   │   last_seen: u64                                                │    │
│  │   │ }                                                               │    │
│  │   │ 用途: 连接追踪，有状态防火墙                                    │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── rate_limit (Hash Map)                                                  │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: 128-bit IPv6 地址                                          │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   rate: u64,        // 速率限制 (PPS)                           │    │
│  │   │   burst: u64,       // 突发容量                                 │    │
│  │   │   tokens: u64,      // 当前令牌数                               │    │
│  │   │   last_update: u64  // 上次更新时间                             │    │
│  │   │ }                                                               │    │
│  │   │ 用途: IP 级别的 PPS 限速                                        │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── ip_port_rules (Hash Map)                                               │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Key: struct {                                                   │    │
│  │   │   ip: [16]u8,                                                   │    │
│  │   │   port: u16                                                     │    │
│  │   │ }                                                               │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   action: u8,                                                   │    │
│  │   │   reason: [64]u8                                                │    │
│  │   │ }                                                               │    │
│  │   │ 用途: IP+端口 级别的精细控制                                    │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  ├── stats (Per-CPU Array)                                                  │
│  │   ┌────────────────────────────────────────────────────────────────┐    │
│  │   │ Index: 0..N (CPU ID)                                            │    │
│  │   │ Value: struct {                                                 │    │
│  │   │   packets_passed: u64,                                          │    │
│  │   │   packets_dropped: u64,                                         │    │
│  │   │   bytes_passed: u64,                                            │    │
│  │   │   bytes_dropped: u64                                            │    │
│  │   │ }                                                               │    │
│  │   │ 用途: 高性能统计，无锁更新                                      │    │
│  │   └────────────────────────────────────────────────────────────────┘    │
│  │                                                                          │
│  └── jmp_table (Program Array)                                              │
│      ┌────────────────────────────────────────────────────────────────┐    │
│      │ Index: 2..15 (插件索引)                                        │    │
│      │ Value: BPF 程序文件描述符                                      │    │
│      │ 用途: Tail Call 插件扩展                                       │    │
│      └────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 性能监控架构 (Performance Monitoring Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          性能监控架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    数据采集层 (Collection)                           │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │ BPF Stats   │ │ Map Ops     │ │ Cache Stats │ │ System Stats│   │   │
│  │  │             │ │             │ │             │ │             │   │   │
│  │  │ • Pass/Drop │ │ • Latency   │ │ • Hit Rate  │ │ • CPU       │   │   │
│  │  │ • Bytes     │ │ • Ops/sec   │ │ • Evictions │ │ • Memory    │   │   │
│  │  │ • PPS       │ │ • Errors    │ │ • Size      │ │ • Goroutine │   │   │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘   │   │
│  │         │               │               │               │          │   │
│  └─────────┴───────────────┴───────────────┴───────────────┴──────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    统计聚合层 (Aggregation)                          │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                  PerformanceStats (internal/xdp)               │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │   │
│  │  │  │  MapOpsStats                                            │  │  │   │
│  │  │  │  • Count: 操作次数                                      │  │  │   │
│  │  │  │  • TotalLatency: 总延迟                                 │  │  │   │
│  │  │  │  • MaxLatency: 最大延迟                                 │  │  │   │
│  │  │  │  • MinLatency: 最小延迟                                 │  │  │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │   │
│  │  │  │  CacheStats                                             │  │  │   │
│  │  │  │  • Hits: 命中次数                                       │  │  │   │
│  │  │  │  • Misses: 未命中次数                                   │  │  │   │
│  │  │  │  • HitRate: 命中率                                      │  │  │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    缓存层 (Caching)                                  │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                  StatsCache (internal/core)                    │  │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │  │   │
│  │  │  │  • TTL-based 缓存过期                                   │  │  │   │
│  │  │  │  • 后台自动刷新                                         │  │  │   │
│  │  │  │  • 并发安全访问                                         │  │  │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                │                                           │
│                                ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    暴露层 (Exposure)                                 │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                   │   │
│  │  │ REST API    │ │ CLI 命令    │ │ Prometheus  │                   │   │
│  │  │             │ │             │ │ Metrics     │                   │   │
│  │  │ /api/stats  │ │ perf show   │ │ :9100/      │                   │   │
│  │  │ /api/perf   │ │ perf latency│ │ metrics     │                   │   │
│  │  │             │ │ perf cache  │ │             │                   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 目录结构 (Directory Structure)

```
netxfw/
├── bpf/                          # eBPF 源代码
│   ├── modules/                  # 核心模块
│   │   ├── core.bpf.c           # 核心逻辑
│   │   ├── maps.bpf.h           # Map 定义
│   │   └── helpers.bpf.h        # 辅助函数
│   ├── protocols/               # 协议处理器
│   │   ├── ipv4.bpf.c           # IPv4 处理
│   │   └── ipv6.bpf.c           # IPv6 处理
│   └── filter.bpf.c             # 主入口
│
├── cmd/netxfw/                   # 主程序入口
│   ├── main.go                  # 入口点
│   └── commands/                # CLI 命令
│       ├── root.go              # 根命令
│       ├── rule.go              # 规则管理
│       ├── limit.go             # 限速管理
│       ├── system.go            # 系统命令
│       ├── perf.go              # 性能监控
│       └── agent/               # Agent 子命令
│
├── internal/                     # 内部包
│   ├── api/                     # REST API
│   │   ├── server.go            # HTTP 服务器
│   │   ├── handlers.go          # 请求处理器
│   │   └── handlers_perf.go     # 性能 API
│   ├── core/                    # 核心逻辑
│   │   ├── config_cache.go      # 配置缓存
│   │   ├── engine.go            # 引擎
│   │   ├── validator.go         # 验证器
│   │   └── stats_cache.go       # 统计缓存
│   ├── xdp/                     # XDP 适配器
│   │   ├── manager.go           # 管理器接口
│   │   ├── loader.go            # 加载器
│   │   ├── migrator.go          # 迁移器
│   │   ├── perf_stats.go        # 性能统计
│   │   └── health_check.go      # 健康检查
│   └── plugins/                 # 插件系统
│       ├── types/               # 类型定义
│       └── agent/               # Agent 插件
│
├── pkg/                          # 公共包
│   ├── sdk/                     # SDK 接口
│   │   ├── sdk.go               # SDK 定义
│   │   └── mock/                # Mock 实现
│   └── storage/                 # 存储层
│
├── docs/                         # 文档
│   ├── standalone/              # 单机版文档
│   │   └── architecture.md      # 架构文档
│   ├── cli/                     # CLI 文档
│   ├── api/                     # API 文档
│   └── testing/                 # 测试文档
│
├── test/                         # 测试
│   ├── unit/                    # 单元测试
│   ├── integration/             # 集成测试
│   └── benchmark/               # 基准测试
│
└── configs/                      # 配置文件
    └── config.yaml              # 默认配置
```
