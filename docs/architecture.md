# 系统架构 (Architecture)

`netxfw` 采用了经典的 "控制面 (Go) + 数据面 (eBPF/XDP)" 架构，并利用 eBPF Map Pinning 实现多进程间的状态共享。

## 版本规划 (Roadmap & Editions)

`netxfw` 规划了以下七个版本，以适应从嵌入式设备到超大规模集群的不同场景：

- **单机版 (Standalone)**: 核心高性能防火墙，支持基础 XDP/eBPF 拦截 and 规则管理。
- **单机 AI 版 (Standalone AI)**: 在单机版基础上集成 TinyML 引擎，支持实时流量异常检测。
- **小集群版 (Small Cluster)**: 支持多节点协同，通过 GitOps 同步策略，适用于 10 台以内服务器。
- **小集群 AI 版 (Small Cluster AI)**: 结合集群管理与 AI 检测能力。
- **大集群版 (Large Cluster)**: 针对成百上千节点优化，支持更复杂的拓扑、分级策略和高性能状态同步。
- **大集群 AI 版 (Large Cluster AI)**: 分布式 AI 检测，支持全局威胁情报共享与联动。
- **嵌入式版 (Embedded)**: 针对 ARM/MIPS 等嵌入式设备优化，极低资源占用，移除 Web UI 等非核心组件。

---

## 核心组件

### 1. 数据面 (Data Plane - eBPF/XDP/TC)
- **位置**：运行在内核中，网卡驱动层 (XDP) 和流量控制层 (TC)。
- **职责**：
    - **包过滤**：使用 LPM (Longest Prefix Match) 算法对 IP 和网段进行毫秒级匹配。
    - **有状态追踪 (Conntrack)**：在 XDP 层拦截入站包，在 TC (Egress) 层监控出站包，自动维护双向连接状态。
    - **流量整形**：基于令牌桶算法对 ICMP 流量进行限速。
    - **高性能统计**：利用 `Per-CPU Map` 记录 pass/drop 计数，避免原子操作在多核下的性能损耗。

### 2. 控制面 (Control Plane - Go)
- **位置**：用户态。
- **职责**：
    - **加载器**：将 eBPF 程序加载到内核并固定到 `/sys/fs/bpf/netxfw`。
    - **状态迁移 (Migrator)**：在热重载期间，负责将旧 BPF Map 中的连接状态和规则无损迁移到新 Map。
    - **Web/API 服务**：提供可视化管理界面和外部集成接口。
    - **规则持久化**：将用户通过 CLI 添加的动态规则同步到本地 JSON 文件，确保重启不丢失。

---

## 核心流程

### 有状态连接追踪 (Conntrack)
`netxfw` 维护了一个 `ct_map` (LRU Hash Map)，用于存储 `(SrcIP, DstIP, SrcPort, DstPort, Protocol)` 五元组。
1. **出站**：当主机主动向外发起请求时，TC 挂载点会捕捉到出站包并向 `ct_map` 写入一条状态。
2. **入站**：当回包到达 XDP 时，程序会先查 `ct_map`。如果存在匹配的状态，则直接放行，无需经过复杂的规则检查。

### 无损热重载 (Hot Reload)
当调整配置（如增大 `lock_list` 容量）时：
1. 控制面启动一个新的 BPF 对象。
2. 通过迭代旧 Map 键值对，将其批量迁移到新 Map。
3. 原子地替换网卡上的 XDP 程序。
4. 关闭旧的 BPF 对象，完成无感知更新。

---

## 流程图

```text
[ 网络数据包 ]
      |
      v
+-----------------------------+
|    XDP (内核态数据面)        | <----------+
+-----------------------------+            |
| 1. Conntrack 状态检查 (Fast) |            |
| 2. 白名单 LPM 匹配          |            |
| 3. 黑名单 LPM 匹配          |            | [ Map Pinning ]
| 4. IP+Port 规则检查         |            | (/sys/fs/bpf/netxfw/)
| 5. 默认策略 (Allow/Deny)     |            |
+-----------------------------+            |
      |                                    |
      +--- [丢弃] ---> (更新 Per-CPU 计数)  |
      |                                    |
      +--- [通过] ---> (进入内核栈/TC更新)   |
                                           |
      +------------------------------------+
      |
+-----------------------------+
|     Go (用户态控制面)        |
+-----------------------------+
| - State Migrator (热重载)   |
| - Web UI / API (11811)      |
| - Rules Persistence (JSON)  |
+-----------------------------+
```
