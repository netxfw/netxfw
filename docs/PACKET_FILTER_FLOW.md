# netxfw BPF 程序数据包过滤流程详解

## 整体架构

netxfw 使用 eBPF/XDP 技术实现高性能的数据包过滤。XDP 程序在网络栈的最前端运行，在内核处理之前就对数据包进行过滤决策，从而实现最低延迟和最高吞吐量。

## 配置管理系统

### 配置缓存机制
- **全局缓存变量**: 使用 `cached_*` 变量存储配置值
- **版本控制**: 通过 `cached_version` 和 `CONFIG_CONFIG_VERSION` 实现配置热更新
- **采样更新**: 每 `CONFIG_REFRESH_INTERVAL` (默认1000) 个数据包刷新一次配置

### 配置项详解
- `cached_default_deny`: 默认拒绝策略开关
- `cached_allow_return`: 返回流量允许开关
- `cached_allow_icmp`: ICMP 流量允许开关
- `cached_ct_enabled`: 连接跟踪功能开关
- `cached_bogon_filter`: Bogon（私有/保留）地址过滤开关
- `cached_strict_tcp`: 严格 TCP 标志位检查开关
- `cached_ratelimit_enabled`: 速率限制功能开关
- `cached_auto_block`: 自动封禁功能开关
- `cached_auto_block_expiry`: 自动封禁过期时间

## 数据包处理流程

### 1. 主入口函数 (`xdp_firewall`)
- **采样式配置刷新**: 每隔一定数量的数据包更新一次配置缓存，减少开销
- **插件系统支持**: 通过跳转表 (`jmp_table`) 支持插件链式调用
- **协议分发**: 根据以太网协议字段分发到对应的处理函数 (IPv4/IPv6)

### 2. IPv4 数据包处理流程 (`handle_ipv4`)

#### 阶段 0: 基础检查与反欺骗
1. **健全性检查与 Bogon 过滤**
   - 如果启用了 Bogon 过滤 (`cached_bogon_filter`)
   - 检查源 IP 是否为私有/保留地址
   - 若是，则直接丢弃 (`XDP_DROP`)

2. **分片检查**
   - 如果启用了分片过滤 (`cached_drop_frags`)
   - 检查 IP 分片标志位
   - 若为分片包，则直接丢弃

3. **协议解析**
   - 解析 TCP/UDP 头部获取端口信息
   - 提取 TCP 标志位用于后续检查

4. **反欺骗检查**
   - 检查源 IP 是否为组播地址或广播地址
   - 若是，则直接丢弃

#### 阶段 1: 白名单检查
- **IP+端口白名单**: 检查源 IP 和目标端口是否在白名单中
- **执行动作**: 匹配则直接通过 (`XDP_PASS`)

#### 阶段 2: 黑名单检查（静态与动态）
- **静态黑名单**: 检查源 IP 是否在 LPM 格式的 `lock_list` 中
- **动态黑名单**: 检查源 IP 是否在 LRU Hash 格式的 `dyn_lock_list` 中
- **优先级**: 动态黑名单优先于静态黑名单
- **计数器更新**: 更新匹配次数
- **执行动作**: 匹配则直接丢弃

#### 阶段 2.5: 速率限制与 SYN 洪水防护
- **条件触发**: 如果启用了速率限制 (`cached_ratelimit_enabled`)
- **SYN 检查**: 特殊处理 SYN 包的速率限制
- **执行动作**: 超限则丢弃

#### 阶段 3: 连接跟踪
- **条件触发**: 如果启用了连接跟踪 (`cached_ct_enabled`)
- **反向查找**: 检查是否为已建立连接的返回流量
- **超时检查**: 验证连接活跃时间是否在阈值内 (`cached_ct_timeout`)
- **执行动作**: 是则通过，否则继续后续检查

#### 阶段 4: IP+端口规则检查
- **精确匹配**: 检查源 IP + 目标端口组合规则
- **动作类型**: 允许 (1)、拒绝 (2) 或继续 (0)
- **执行动作**: 根据规则动作决定

#### 阶段 5: ICMP 过滤
- **条件触发**: 如果协议为 ICMP 且允许 ICMP (`cached_allow_icmp`)
- **速率限制**: 检查 ICMP 速率限制 (`cached_icmp_rate`, `cached_icmp_burst`)
- **执行动作**: 符合限制则通过，否则丢弃

#### 阶段 6: 返回流量处理
- **条件触发**: 如果启用了返回流量允许 (`cached_allow_return`) 且未启用连接跟踪
- **判断逻辑**: TCP ACK 包或高编号 UDP 端口 (>= 32768)
- **执行动作**: 符合条件则通过

#### 阶段 7: 默认拒绝/端口白名单
- **条件触发**: 如果启用了默认拒绝 (`cached_default_deny`)
- **全局端口白名单**: 检查目标端口是否在全局允许列表中 (`allowed_ports`)
- **执行动作**: 在白名单中则通过，否则丢弃

### 3. IPv6 数据包处理流程 (`handle_ipv6`)

IPv6 的处理流程与 IPv4 基本一致，主要差异在于：

1. **协议头部**: 使用 IPv6 头部结构 (`ipv6hdr`) 和下一头部字段 (`nexthdr`)
2. **地址格式**: 使用 128 位 IPv6 地址结构
3. **ICMPv6**: 支持 ICMPv6 协议
4. **映射表**: 使用 IPv6 特定的映射表 (如 `conntrack_map6`, `dyn_lock_list6` 等)

## 动态黑名单系统

### 动态黑名单特性
- **数据结构**: 使用 LRU Hash 表 (`dyn_lock_list` / `dyn_lock_list6`)
- **容量限制**: LRU 机制确保最近最少使用的条目被自动清除
- **自动封禁**: 支持基于流量模式的自动封禁功能
- **过期时间**: 支持基于 `cached_auto_block_expiry` 的自动过期

### 静态 vs 动态黑名单
- **静态黑名单 (`lock_list`)**: 
  - 使用 LPM Trie 结构
  - 支持 CIDR 网段匹配
  - 适用于长期封禁规则
- **动态黑名单 (`dyn_lock_list`)**:
  - 使用 LRU Hash 结构
  - 仅支持单 IP 匹配
  - 适用于临时封禁和自动封禁
  - 优先级高于静态黑名单

### 用户空间管理
- **CLI 命令**: `./netxfw display lock` 命令会同时显示静态和动态黑名单
- **标识区分**: 动态黑名单条目后缀标注 "(auto)" 以示区分
- **同步机制**: 通过 BPF 映射表在内核和用户空间之间同步数据

## 性能优化策略

### 1. 采样式配置刷新
- **减少开销**: 不是每个数据包都读取配置
- **平衡更新频率**: 每 1000 个数据包更新一次配置
- **保持实时性**: 在性能和配置更新之间取得平衡

### 2. 早期过滤策略
- **优先级排序**: 按威胁程度和检查成本排序过滤步骤
- **快速路径**: 最常见的合法流量走最短路径
- **早期丢弃**: 恶意流量在早期阶段就被识别和丢弃

### 3. 内存访问优化
- **缓存局部性**: 相关数据结构在内存中紧密排列
- **最小化查找**: 使用高效的数据结构（LPM trie, hash map）
- **批量操作**: 在适当的地方使用原子操作

## 安全特性

### 1. 多层防御
- **协议层面**: TCP/UDP 合规性检查
- **网络层面**: IP 欺骗防护、Bogon 过滤
- **应用层面**: IP+端口规则、速率限制

### 2. 自适应防护
- **动态配置**: 支持运行时配置调整
- **自学习**: 通过连接跟踪了解正常通信模式
- **自动化**: 支持自动封禁异常流量

## 可扩展性设计

### 1. 插件架构
- **模块化**: 功能分解为独立模块
- **插件系统**: 通过跳转表支持功能扩展
- **热加载**: 支持运行时功能增减

### 2. 配置驱动
- **策略可变**: 行为完全由配置决定
- **远程管理**: 支持远程配置更新
- **版本控制**: 配置变更可追溯

## 数据流向图

```
数据包到达 → 协议识别 → [IPv4] → 健全性检查 → 反欺骗 → 白名单 → 黑名单(动态) → 黑名单(静态) → 速率限制 → 连接跟踪 → IP+端口规则 → ICMP → 返回流量 → 默认策略 → 决策(XDP_PASS/DROP)

                     ↓
                  [IPv6] → (同上，适配IPv6格式)
```

## 总结

netxfw 的过滤流程采用了多层次、多阶段的安全策略，从最基础的协议合规性检查到高级的应用层规则匹配，形成了完整的安全防护体系。通过精心设计的处理顺序和高效的 BPF 代码，实现了高性能的数据包过滤能力。配置管理系统确保了运行时的灵活性，而性能优化策略保证了在高负载下的稳定运行。动态黑名单系统提供了自动化的威胁应对能力，结合静态黑名单形成完整的访问控制体系。