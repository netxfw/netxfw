# netxfw â€” å¯æ‰©å±•çš„ eBPF é˜²ç«å¢™

[![License](https://img.shields.io/badge/license-Apache--2.0-blue.svg)](LICENSE)
[![BPF License](https://img.shields.io/badge/BPF-Dual%20BSD/GPL-purple.svg)](bpf/LICENSE)
[![Go Report Card](https://goreportcard.com/badge/github.com/livp123/netxfw)](https://goreportcard.com/report/github.com/livp123/netxfw)
[![Release](https://img.shields.io/github/v/release/livp123/netxfw)](https://github.com/livp123/netxfw/releases)
[![English README](https://img.shields.io/badge/README-English-blue.svg)](README_en.md)

> **è½»é‡ Â· é«˜æ€§èƒ½ Â· æ˜“æ‰©å±•**
> åŸºäº eBPF/XDP çš„ä¸‹ä¸€ä»£ Linux ä¸»æœºé˜²ç«å¢™ã€‚

`netxfw` æ˜¯ä¸€æ¬¾åˆ©ç”¨ç°ä»£ Linux å†…æ ¸ eBPF æŠ€æœ¯æ„å»ºçš„é«˜æ€§èƒ½é˜²ç«å¢™ã€‚å®ƒåœ¨ç½‘ç»œé©±åŠ¨å±‚ï¼ˆXDPï¼‰ç›´æ¥å¤„ç†æ•°æ®åŒ…ï¼Œèƒ½å¤Ÿä»¥æä½çš„ CPU å¼€é”€é˜»æ–­å¤§è§„æ¨¡ DDoS æ”»å‡»ã€æš´åŠ›ç ´è§£å’Œéæ³•æ‰«æã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **æè‡´æ€§èƒ½**ï¼šåœ¨ç½‘å¡é©±åŠ¨å±‚ï¼ˆXDPï¼‰ç›´æ¥ä¸¢å¼ƒæ¶æ„åŒ…ï¼Œç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆï¼ŒCPU å ç”¨æä½ã€‚
- ğŸŒ **å…¨åè®®æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒ IPv4 å’Œ IPv6ï¼Œæ”¯æŒ CIDR ç½‘æ®µå°ç¦ã€‚
- ğŸ§  **æœ‰çŠ¶æ€æ£€æµ‹ (Conntrack)**ï¼šå†…ç½®é«˜æ•ˆçš„è¿æ¥è¿½è¸ªå¼•æ“ï¼Œè‡ªåŠ¨æ”¾è¡Œå·²å»ºç«‹è¿æ¥çš„å›åŒ…ã€‚
- ğŸ›¡ï¸ **ç»†ç²’åº¦è§„åˆ™**ï¼šæ”¯æŒ IP+ç«¯å£ çº§åˆ«çš„ Allow/Deny è§„åˆ™ï¼Œæ»¡è¶³å¤æ‚ä¸šåŠ¡éœ€æ±‚ã€‚
- âš¡ **åŠ¨æ€é»‘åå•**ï¼šå¼•å…¥åŸºäº `LRU_HASH` çš„é«˜é€Ÿå• IP åŒ¹é…æœºåˆ¶ï¼Œä¸“ä¸ºæ‹¦æˆªé«˜é¢‘å˜åŒ–çš„æ¶æ„ IP è®¾è®¡ã€‚
- ğŸ¤– **è‡ªåŠ¨æ‹¦æˆª (Auto-Blocking)**ï¼š**é˜²å¾¡ DDoS çš„åˆ©å™¨**ã€‚å½“ IP è§¦å‘é™é€Ÿé˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿå¯è‡ªåŠ¨å°†å…¶åŠ å…¥åŠ¨æ€é»‘åå•ï¼Œå®ç°å†…æ ¸çº§çš„æ¯«ç§’çº§å°ç¦ã€‚æ”¯æŒé…ç½®æ‹¦æˆªæ—¶é•¿ï¼Œåˆ©ç”¨ LRU ç‰¹æ€§è‡ªåŠ¨æ·˜æ±°ã€‚
- âš¡ **æ— æŸçƒ­é‡è½½**ï¼šæ”¯æŒè¿è¡Œæ—¶è°ƒæ•´ Map å®¹é‡å¹¶çƒ­é‡è½½ç¨‹åºï¼Œé€šè¿‡çŠ¶æ€è¿ç§»ç¡®ä¿ä¸šåŠ¡é›¶ä¸­æ–­ã€‚
    - **å¢é‡æ›´æ–° (Incremental)**: å½“ Map å®¹é‡æœªå˜æ›´æ—¶ï¼Œç›´æ¥æ›´æ–°ç°æœ‰ Mapï¼Œé¿å…å…¨é‡è¿ç§»ï¼Œå®ç°æ¯«ç§’çº§é‡è½½ã€‚
    - **å…¨é‡è¿ç§» (Full Migration)**: å½“å®¹é‡å˜æ›´æ—¶ï¼Œè‡ªåŠ¨è¿ç§»æ—§ Map æ•°æ®åˆ°æ–° Mapï¼Œç¡®ä¿è¿æ¥è·Ÿè¸ªå’Œè§„åˆ™ä¸ä¸¢å¤±ã€‚
- ğŸŒŠ **æµé‡æ•´å½¢**ï¼šå†…ç½®åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„ IP çº§åˆ«é™é€Ÿä¸ ICMP é™é€Ÿã€‚å¼•å…¥ **O(1) é…ç½®ç¼“å­˜** æœºåˆ¶ï¼Œé¿å…äº†æ¯ä¸ªæ•°æ®åŒ…çš„å¤æ‚æŸ¥æ‰¾ã€‚
- ğŸ›¡ï¸ **å®‰å…¨åŠ å›º**ï¼š
    - **Bogon è¿‡æ»¤**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶ä¸¢å¼ƒæ¥è‡ªä¿ç•™/ç§æœ‰ IP åœ°å€æ®µçš„æ¶æ„æµé‡ã€‚
    - **ä¸¥æ ¼ TCP æ ¡éªŒ**ï¼šæ ¡éªŒ TCP æ ‡å¿—ä½ç»„åˆï¼Œæœ‰æ•ˆé˜²å¾¡ Null Scanã€Xmas Scan ç­‰æ¢æµ‹æ”»å‡»ã€‚
    - **åˆ†ç‰‡ä¿æŠ¤**ï¼šæ”¯æŒé…ç½®ä¸¢å¼ƒæ‰€æœ‰ IP åˆ†ç‰‡åŒ…ï¼Œé˜²å¾¡åˆ†ç‰‡æ”»å‡»ã€‚
    - **SYN æ´ªæ°´é˜²å¾¡**ï¼šæ”¯æŒä»…å¯¹ SYN åŒ…åº”ç”¨é™é€Ÿï¼Œç¡®ä¿åœ¨é­é‡ SYN Flood æ—¶æ­£å¸¸ä¸šåŠ¡ä¸å—å½±å“ã€‚
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šå†…ç½® Web ç®¡ç†ç•Œé¢ï¼ˆé»˜è®¤ 11811 ç«¯å£ï¼‰ä¸ Prometheus Exporterï¼Œå®æ—¶ç›‘æ§ä¸¢åŒ…é€Ÿç‡ä¸æ´»è·ƒè¿æ¥ã€‚
- ğŸ§© **æ’ä»¶åŒ–æ¶æ„ (SDK)**ï¼š
    - **Plugin SDK**: æä¾›æ ‡å‡†åŒ–çš„ Go æ¥å£ (`sdk.Plugin`)ï¼Œå…è®¸å¼€å‘è€…è½»æ¾æ‰©å±•é˜²ç«å¢™åŠŸèƒ½ã€‚
    - **CEL è§„åˆ™å¼•æ“**: é›†æˆ Google CEL è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒå¯¹æ—¥å¿—è¿›è¡Œå¤æ‚çš„ JSON/KV è§£æå’Œæ­£åˆ™åŒ¹é… (`JSON()`, `KV()`, `Match()`)ã€‚
    - **åŠ¨æ€åŠ è½½**: æ”¯æŒé€šè¿‡ eBPF Tail Call åŠ¨æ€åŠ è½½ç¬¬ä¸‰æ–¹æ’ä»¶ã€‚è¯¦æƒ…è¯·å‚è€ƒ [æ’ä»¶å¼€å‘æŒ‡å—](docs/plugins/plugins.md)ã€‚
    - **æ’ä»¶é—´é€šä¿¡ (IPC)**:
        - **EventBus**: åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„äº‹ä»¶æ€»çº¿ï¼Œå®ç°æ’ä»¶è§£è€¦é€šä¿¡ï¼ˆå¦‚æ—¥å¿—å¼•æ“ -> AI åˆ†æï¼‰ã€‚
        - **KV Store**: å…±äº«çš„å†…å­˜é”®å€¼å­˜å‚¨ (`sdk.Store`)ï¼Œç”¨äºæ’ä»¶é—´å…±äº«è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ï¼ˆå¦‚å¨èƒæƒ…æŠ¥ã€ä¿¡ä»»åˆ†ï¼‰ã€‚
- ğŸ—ï¸ **æ¨¡å—åŒ–è®¾è®¡**ï¼šBPF ä»£ç é‡‡ç”¨æ¨¡å—åŒ–ç»“æ„ï¼ˆFilter, Ratelimit, Conntrack, Protocolsï¼‰ï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ã€‚
- ğŸ› ï¸ **å‘½ä»¤è¡Œæ§åˆ¶**ï¼šæç®€çš„ CLI æ“ä½œï¼Œæ”¯æŒåŠ¨æ€åŠ è½½è§„åˆ™å’Œæ’ä»¶ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚


---

## âš™ï¸ æ ¸å¿ƒé…ç½®

åœ¨é…ç½®æ–‡ä»¶ï¼ˆé»˜è®¤ä¸º `/etc/netxfw/config.yaml`ï¼‰ä¸­å¯ç”¨è‡ªåŠ¨æ‹¦æˆªåŠŸèƒ½ï¼š

```yaml
rate_limit:
  enabled: true
  auto_block: true          # å¼€å¯è‡ªåŠ¨æ‹¦æˆª
  auto_block_expiry: "5m"   # è‡ªåŠ¨æ‹¦æˆªçš„æ—¶é•¿ï¼Œæ”¯æŒ s, m, h
  rules:
    - ip: "0.0.0.0/0"
      rate: 1000            # æ¯ç§’åŒ…æ•°é™åˆ¶
      burst: 2000           # å…è®¸çš„æœ€å¤§çªå‘
```

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

`netxfw` é‡‡ç”¨æ§åˆ¶é¢ä¸æ•°æ®é¢åˆ†ç¦»çš„æ¶æ„ï¼š
1. **æ•°æ®é¢ (eBPF/XDP/TC)**ï¼š
    - **XDP**ï¼šåœ¨ç½‘ç»œé©±åŠ¨å±‚è¿›è¡Œæé€ŸåŒ…è¿‡æ»¤ï¼ˆç»Ÿä¸€ IPv4/IPv6 LPM åŒ¹é…ã€è¿æ¥è¿½è¸ªçŠ¶æ€æ£€æŸ¥ï¼‰ã€‚
    - **TC (Egress)**ï¼šåœ¨æµé‡å‡ºç«™æ—¶æ›´æ–°è¿æ¥è¿½è¸ªçŠ¶æ€ã€‚
    - **ä¼˜åŒ–**ï¼šä½¿ç”¨ `Per-CPU Map` å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¶ˆé™¤å¤šæ ¸ç«äº‰ã€‚
2. **æ§åˆ¶é¢ (Go)**ï¼š
    - **Manager**ï¼šè´Ÿè´£ BPF ç¨‹åºçš„åŠ è½½ã€å›ºå®šï¼ˆPinningï¼‰åŠç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
    - **State Migrator**ï¼šå®ç°çƒ­é‡è½½æœŸé—´çš„ BPF Map æ•°æ®æ— ç¼è¿ç§»ã€‚
    - **Web UI**ï¼šæä¾›æç®€çš„å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼ŒæŸ¥çœ‹å®æ—¶ç»Ÿè®¡ä¸æ´»è·ƒè¿æ¥ã€‚
    - **CLI/API**ï¼šæä¾›ç”¨æˆ·äº¤äº’æ¥å£ã€‚
    - **Metrics**ï¼šæš´éœ² Prometheus ç›‘æ§æŒ‡æ ‡ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…æ–¹å¼

#### æ–¹å¼ Aï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ¨èï¼‰
ä» [Releases](https://github.com/livp123/netxfw/releases) é¡µé¢ä¸‹è½½ï¼š

- **x86_64 (amd64)**:
  ```bash
  wget https://github.com/livp123/netxfw/releases/download/v0.2.2/netxfw_Linux_x86_64.tar.gz
  ```
- **ARM64 (aarch64)**:
  ```bash
  wget https://github.com/livp123/netxfw/releases/download/v0.2.2/netxfw_Linux_arm64.tar.gz
  ```

**å®‰è£…**:
```bash
tar -zxvf netxfw_Linux_*.tar.gz
sudo mv netxfw /usr/local/bin/
```

#### æ–¹å¼ Bï¼šä»æºç æ„å»º

**ç¯å¢ƒè¦æ±‚**ï¼š
- Linux Kernel >= 5.4 (æ¨è 5.10+)
- Go >= 1.21

**å®‰è£…ç¼–è¯‘å·¥å…·**ï¼š
```bash
# Debian/Ubuntu
sudo apt-get install -y clang llvm libelf-dev libbpf-dev make
```

**ç¼–è¯‘**:
```bash
git clone https://github.com/livp123/netxfw.git
cd netxfw
make generate
make
```

### 2. è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®åŠ è½½é˜²ç«å¢™
sudo ./netxfw system load
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¶æ„è®¾è®¡](docs/architecture_zh.md)
- [å‘½ä»¤è¡Œæ‰‹å†Œ](docs/cli/cli.md)
- [æ’ä»¶å¼€å‘æŒ‡å—](docs/plugins/plugins.md)
- [è´¡çŒ®æŒ‡å—](CONTRIBUTING_zh.md)
- [å®‰å…¨ç­–ç•¥](SECURITY_zh.md)
- [è¡Œä¸ºå‡†åˆ™](CODE_OF_CONDUCT_zh.md)
- [å˜æ›´æ—¥å¿—](CHANGELOG_zh.md)

## ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨æ··åˆè®¸å¯è¯ï¼š

- **Go ç”¨æˆ·ç©ºé—´ä»£ç **: [Apache-2.0](LICENSE)
- **BPF å†…æ ¸ä»£ç **: [Dual BSD/GPL](bpf/LICENSE) (BSD-2-Clause OR GPL-2.0-only)

è¯¦è§ [NOTICE](NOTICE) æ–‡ä»¶äº†è§£è®¸å¯è¯ç»“æ„ã€‚
