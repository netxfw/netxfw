# netxfw â€” The eXtensible eBPF Firewall

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Go Report Card](https://goreportcard.com/badge/github.com/livp123/netxfw)](https://goreportcard.com/report/github.com/livp123/netxfw)
[![Release](https://img.shields.io/github/v/release/livp123/netxfw)](https://github.com/livp123/netxfw/releases)

> **è½»é‡ Â· é«˜æ€§èƒ½ Â· æ˜“æ‰©å±•**  
> åŸºäº eBPF/XDP çš„ä¸‹ä¸€ä»£ Linux ä¸»æœºé˜²ç«å¢™ã€‚

`netxfw` æ˜¯ä¸€æ¬¾åˆ©ç”¨ç°ä»£ Linux å†…æ ¸ eBPF æŠ€æœ¯æ„å»ºçš„é«˜æ€§èƒ½é˜²ç«å¢™ã€‚å®ƒåœ¨ç½‘ç»œé©±åŠ¨å±‚ï¼ˆXDPï¼‰ç›´æ¥å¤„ç†æ•°æ®åŒ…ï¼Œèƒ½å¤Ÿä»¥æä½çš„ CPU å¼€é”€é˜»æ–­å¤§è§„æ¨¡ DDoS æ”»å‡»ã€æš´åŠ›ç ´è§£å’Œéæ³•æ‰«æã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **æè‡´æ€§èƒ½**ï¼šåœ¨ç½‘å¡é©±åŠ¨å±‚ï¼ˆXDPï¼‰ç›´æ¥ä¸¢å¼ƒæ¶æ„åŒ…ï¼Œç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆï¼ŒCPU å ç”¨æä½ã€‚
- â±ï¸ **é«˜ç²¾åº¦è¿‡æœŸæ§åˆ¶**ï¼šeBPF Map åŸç”Ÿæ”¯æŒ `expires_at` æ—¶é—´æˆ³ï¼Œå†…æ ¸æ€æ¯«ç§’çº§ç²¾å‡†åˆ¤å®šï¼Œæ”¯æŒ `--ttl` åŠ¨æ€ä¸‹å‘ã€‚
- ğŸŒ **å…¨åè®®æ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒ IPv4 å’Œ IPv6ï¼Œæ”¯æŒ CIDR ç½‘æ®µå°ç¦ã€‚
- ï¿½ **æ’ä»¶åŒ–æ¶æ„**ï¼šæ”¯æŒåŠ¨æ€åŠ è½½æ’ä»¶ï¼ˆå¦‚ `netxfw-plugins-port`ï¼‰ï¼Œè½»æ¾æ‰©å±•é«˜çº§è¿‡æ»¤é€»è¾‘ã€‚
- ğŸ›¡ï¸ **é«˜çº§è§„åˆ™æ§åˆ¶**ï¼šæ”¯æŒç‰¹å®š IP/ç½‘æ®µè®¿é—®ç‰¹å®šç«¯å£ï¼ˆIP+Portï¼‰ï¼Œæ”¯æŒé»˜è®¤æ‹’ç»ï¼ˆDefault Denyï¼‰ç­–ç•¥ã€‚ï¼ˆ*æ³¨ï¼šIP+Port åŠŸèƒ½ç›®å‰ä»åœ¨å®Œå–„ä¸­*ï¼‰
- ğŸ”„ **çŠ¶æ€åŒæ­¥**ï¼šXDP Map ä½œä¸ºå•ä¸€äº‹å®æ¥æºï¼Œæ”¯æŒä¸é…ç½®æ–‡ä»¶åŠå¤–éƒ¨å­˜å‚¨ï¼ˆé¢„ç•™ Redis/SQLite æ”¯æŒï¼‰å®æ—¶åŒæ­¥ã€‚
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šå†…ç½® Prometheus Exporterï¼Œå®æ—¶ç›‘æ§ä¸¢åŒ…é€Ÿç‡ä¸æµé‡è¶‹åŠ¿ã€‚
- ğŸ› ï¸ **ä¸€ä»¤å°ç½‘**ï¼šæç®€çš„ CLI æ“ä½œï¼Œæ”¯æŒåŠ¨æ€åŠ è½½è§„åˆ™ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚

---

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

`netxfw` ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
1.  **å†…æ ¸æ€ (eBPF/XDP)**ï¼šé«˜æ€§èƒ½æ•°æ®é¢ï¼Œè´Ÿè´£æ ¹æ®ç™½åå•ã€é”å®šåˆ—è¡¨åŠç«¯å£è§„åˆ™è¿›è¡Œæé€Ÿè¿‡æ»¤ã€‚
    - **æ—¶é—´æˆ³åˆ¤å®š**ï¼šMap å€¼ä¸­åŒ…å« `expires_at` (åŸºäº `bpf_ktime_get_ns()`)ï¼Œåœ¨å†…æ ¸æ€ç›´æ¥åˆ¤å®šè§„åˆ™æ˜¯å¦è¿‡æœŸï¼Œå®ç°â€œé›¶å»¶è¿Ÿâ€å¤±æ•ˆã€‚
2.  **ç”¨æˆ·æ€ (Go)**ï¼šæ§åˆ¶é¢ï¼Œè´Ÿè´£è§„åˆ™è§£æã€ç½‘å¡ç®¡ç†ã€æ’ä»¶è°ƒåº¦åŠæŒ‡æ ‡æš´éœ²ã€‚
    - **è‡ªåŠ¨æ¸…ç†**ï¼šDaemon è¿›ç¨‹ä¼šå®šæœŸï¼ˆ30sï¼‰æ‰«æå¹¶ç‰©ç†ç§»é™¤ Map ä¸­å·²è¿‡æœŸçš„æ¡ç›®ï¼Œé‡Šæ”¾å†…å­˜ã€‚
3.  **æŒä¹…åŒ–å±‚**ï¼šæ”¯æŒ YAML åŒæ­¥ï¼Œç¡®ä¿é‡å¯åè§„åˆ™ä¸ä¸¢å¤±ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚
- Linux Kernel >= 5.4 (æ¨è 5.10+)
- Go >= 1.22

### 2. ç¼–è¯‘ä¸å®‰è£…
```bash
git clone https://github.com/livp123/netxfw.git
cd netxfw
make generate
make build
sudo make install
```

### 3. è¿è¡ŒæœåŠ¡
```bash
# åŠ è½½ XDP ç¨‹åº
sudo ./netxfw load xdp

# å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¼€å¯è§„åˆ™åŒæ­¥ä¸ç›‘æ§ï¼‰
sudo ./netxfw daemon
```

---

## ğŸ› ï¸ å¸¸ç”¨æ“ä½œ

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
| :--- | :--- | :--- |
| `lock` | å°ç¦æŒ‡å®š IP/ç½‘æ®µ | `sudo ./netxfw lock 1.2.3.4` |
| `lock --ttl` | ä¸´æ—¶å°ç¦ (æ”¯æŒ h/m/s) | `sudo ./netxfw lock 1.2.3.4 --ttl 1h30m` |
| `unlock` | è§£å°æŒ‡å®š IP/ç½‘æ®µ | `sudo ./netxfw unlock 1.2.3.4` |
| `allow` | åŠ å…¥ç™½åå• | `sudo ./netxfw allow 1.2.3.4` |
| `allow --ttl` | ä¸´æ—¶ç™½åå• | `sudo ./netxfw allow 1.2.3.4 --ttl 30m` |
| `allow --port` | ç‰¹å®š IP è®¿é—®ç‰¹å®šç«¯å£ | `sudo ./netxfw allow 10.0.0.5 --port 80/tcp` |
| `allow --port --ttl` | ä¸´æ—¶å…è®¸è®¿é—®ç«¯å£ | `sudo ./netxfw allow 10.0.0.5 --port 80/tcp --ttl 1h` |
| `list` | æŸ¥çœ‹å½“å‰è§„åˆ™åŠç»Ÿè®¡ | `sudo ./netxfw list` |
| `plugin list` | æŸ¥çœ‹å¯ç”¨æ’ä»¶ | `sudo ./netxfw plugin list` |

---

## ğŸ§© æ’ä»¶ç³»ç»Ÿ

`netxfw` æ”¯æŒç‹¬ç«‹çš„æ’ä»¶é…ç½®æ–‡ä»¶ï¼Œä½äº `rules/plugins/` ç›®å½•ä¸‹ã€‚

### ç«¯å£ç®¡ç†æ’ä»¶ (`netxfw-plugins-port`)
æ”¯æŒåŸºäºç«¯å£çš„ç²¾ç»†åŒ–è®¿é—®æ§åˆ¶ï¼š
- **é»˜è®¤ç­–ç•¥**ï¼šå¯è®¾ç½®ä¸ºå…¨éƒ¨æ‹¦æˆªï¼ˆDefault Denyï¼‰ï¼Œä»…æ”¾è¡Œè§„åˆ™å†…ç«¯å£ã€‚
- **IP+ç«¯å£è§„åˆ™**ï¼šå…è®¸ç‰¹å®šæ¥æºè®¿é—®ç‰¹å®šæœåŠ¡ã€‚
- **è¿‡æœŸè‡ªåŠ¨æ¸…ç†**ï¼šæ”¯æŒä¸ºè§„åˆ™è®¾ç½® `expires_at` å­—æ®µã€‚

**é…ç½®ç¤ºä¾‹ (`rules/plugins/netxfw-plugin-port.yaml`):**
```yaml
- rules:
    - port: 80
      protocol: tcp
      action: allow
  ip_port_rules:
    - cidr: "10.0.0.5/32"
      port: 22
      protocol: tcp
      action: allow
      expires_at: "2026-01-29T15:00:00Z" # å¯é€‰ï¼šè¿‡æœŸæ—¶é—´ (RFC3339)
```

### åŸºç¡€è§„åˆ™è¿‡æœŸæ”¯æŒ
ç™½åå•å’Œé»‘åå•åŒæ ·æ”¯æŒè¿‡æœŸæ—¶é—´å­—æ®µï¼š
```yaml
whitelist:
  - cidr: "192.168.1.100/32"
    expires_at: "2026-01-30T00:00:00Z"
lock_list:
  - cidr: "1.2.3.4/32"
    expires_at: "2026-01-28T18:00:00Z"
```

---

## ğŸ“ˆ ç›‘æ§é›†æˆ

é»˜è®¤åœ¨ `9100` ç«¯å£æš´éœ² Prometheus æŒ‡æ ‡ã€‚

**å…³é”®æŒ‡æ ‡**ï¼š
- `netxfw_xdp_drop_total`: è¢«é˜²ç«å¢™æ‹¦æˆªçš„æ€»åŒ…æ•°ã€‚
- `netxfw_xdp_pass_total`: é€šè¿‡é˜²ç«å¢™çš„æ€»åŒ…æ•°ã€‚
- `netxfw_locked_ips_count`: å½“å‰è¢«å°ç¦çš„ IP æ•°é‡ã€‚

---

## ğŸ—ºï¸ è·¯çº¿å›¾ (Roadmap)

- [x] æ ¸å¿ƒ XDP è¿‡æ»¤å¼•æ“ (IPv4/IPv6)
- [x] æ’ä»¶åŒ–æ¶æ„æ”¯æŒ
- [ ] IP+Port é«˜çº§è¿‡æ»¤è§„åˆ™ (å®Œå–„ä¸­)
- [x] è§„åˆ™çŠ¶æ€è‡ªåŠ¨åŒæ­¥ (XDP <-> Config)
- [ ] è‡ªåŠ¨åŒ–æ”»å‡»æ£€æµ‹å¼•æ“
- [ ] Redis/PostgreSQL å­˜å‚¨æ”¯æŒ
- [ ] Web æ§åˆ¶å°

---

## ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT](LICENSE) åè®®å¼€æºã€‚
